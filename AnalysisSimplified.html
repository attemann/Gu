<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Settings Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status-bar {
            background: #e8f4f8;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online { background-color: #27ae60; }
        .status-offline { background-color: #e74c3c; }
        
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
            font-size: 14px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn.refresh {
            background-color: #27ae60;
        }
        
        .btn.refresh:hover {
            background-color: #219a52;
        }
        
        .data-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .accuracy-display {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .gps-data, .config-data, .accuracy-data {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
        
        .gps-data h2, .config-data h2, .accuracy-data h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table td:first-child {
            font-weight: bold;
            color: #34495e;
            width: 40%;
        }
        
        .data-table td:last-child {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
        }
        
        .config-display {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            line-height: 1.4;
        }
        
        .loading {
            color: #666;
            font-style: italic;
        }
        
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .metric-good { color: #27ae60; }
        .metric-warning { color: #f39c12; }
        .metric-error { color: #e74c3c; }
        
        .rtcm-messages {
            font-size: 11px;
            line-height: 1.2;
        }
        
        .log-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
            margin-top: 20px;
        }
        
        .log-display h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }
        
        .log-content {
            background: #1a1a1a;
            color: #00ff00;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GPS Settings Monitor</h1>
        
        <div class="status-bar">
            <div>
                <span id="connection-status" class="status-indicator status-offline"></span>
                <span id="connection-text">Connecting...</span>
            </div>
            <div>
                <span id="data-status">Last updated: Never</span>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn refresh" onclick="requestCurrentConfig()">Refresh Configuration</button>
            <button class="btn" onclick="clearLog()">Clear Log</button>
            <button class="btn" onclick="resetStatistics()">Reset Statistics</button>
            <button class="btn" onclick="initWebSocket()">Reconnect</button>
        </div>
        
        <div class="data-display">
            <div class="gps-data">
                <h2>Current GPS Data</h2>
                <table class="data-table">
                    <tr>
                        <td>Latitude:</td>
                        <td id="gps-lat">--</td>
                    </tr>
                    <tr>
                        <td>Longitude:</td>
                        <td id="gps-lon">--</td>
                    </tr>
                    <tr>
                        <td>Elevation:</td>
                        <td id="gps-ele">--</td>
                    </tr>
                    <tr>
                        <td>Fix Type:</td>
                        <td id="gps-type">--</td>
                    </tr>
                    <tr>
                        <td>Satellites:</td>
                        <td id="gps-siv">--</td>
                    </tr>
                    <tr>
                        <td>HDOP:</td>
                        <td id="gps-hdop">--</td>
                    </tr>
                    <tr>
                        <td>RSSI:</td>
                        <td id="gps-rssi">--</td>
                    </tr>
                </table>
            </div>
            
            <div class="config-data">
                <h2>Current Configuration</h2>
                <div id="config-display" class="config-display">
                    <span class="loading">Loading configuration...</span>
                </div>
            </div>
        </div>
        
        <div class="accuracy-display">
            <div class="accuracy-data">
                <h2>Position Accuracy</h2>
                <table class="data-table">
                    <tr>
                        <td>A95 Ellipse:</td>
                        <td id="acc-a95">--</td>
                    </tr>
                    <tr>
                        <td>DRMS:</td>
                        <td id="acc-drms">--</td>
                    </tr>
                    <tr>
                        <td>R95:</td>
                        <td id="acc-r95">--</td>
                    </tr>
                    <tr>
                        <td>Rolling DRMS:</td>
                        <td id="acc-rolling-drms">--</td>
                    </tr>
                </table>
            </div>
            
            <div class="accuracy-data">
                <h2>Component Stats</h2>
                <table class="data-table">
                    <tr>
                        <td>North MAD-σ:</td>
                        <td id="acc-north-mad">--</td>
                    </tr>
                    <tr>
                        <td>East MAD-σ:</td>
                        <td id="acc-east-mad">--</td>
                    </tr>
                    <tr>
                        <td>Allan Dev:</td>
                        <td id="acc-allan">--</td>
                    </tr>
                    <tr>
                        <td>Outlier Rate:</td>
                        <td id="acc-outliers">--</td>
                    </tr>
                </table>
            </div>
            
            <div class="accuracy-data">
                <h2>Session Stats</h2>
                <table class="data-table">
                    <tr>
                        <td>Total Fixes:</td>
                        <td id="acc-fixes">--</td>
                    </tr>
                    <tr>
                        <td>Continuous Fix:</td>
                        <td id="acc-continuous">--</td>
                    </tr>
                    <tr>
                        <td>Session Time:</td>
                        <td id="acc-session-time">--</td>
                    </tr>
                    <tr>
                        <td>RTCM Messages:</td>
                        <td id="acc-rtcm" class="rtcm-messages">--</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="log-display">
            <h2>Activity Log</h2>
            <div id="log-content" class="log-content"></div>
        </div>
        
        <div class="log-display">
            <h2>Metric Descriptions</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 15px;">
                    <div style="padding: 12px; background-color: white; border-radius: 5px; border-left: 4px solid #3498db; font-size: 0.9em; line-height: 1.4;">
                        <strong style="color: #2c3e50; display: block; margin-bottom: 5px;">Covariance Ellipse Area (A95):</strong> Area of 95% confidence ellipse in m², indicating positioning uncertainty.
                    </div>
                    <div style="padding: 12px; background-color: white; border-radius: 5px; border-left: 4px solid #3498db; font-size: 0.9em; line-height: 1.4;">
                        <strong style="color: #2c3e50; display: block; margin-bottom: 5px;">DRMS:</strong> Distance Root Mean Square - circular error probable at 63% confidence level.
                    </div>
                    <div style="padding: 12px; background-color: white; border-radius: 5px; border-left: 4px solid #3498db; font-size: 0.9em; line-height: 1.4;">
                        <strong style="color: #2c3e50; display: block; margin-bottom: 5px;">R95:</strong> Radial error at 95% confidence level - radius containing 95% of position fixes.
                    </div>
                    <div style="padding: 12px; background-color: white; border-radius: 5px; border-left: 4px solid #3498db; font-size: 0.9em; line-height: 1.4;">
                        <strong style="color: #2c3e50; display: block; margin-bottom: 5px;">North/East MAD-σ:</strong> Median Absolute Deviation based standard deviation for North and East components.
                    </div>
                    <div style="padding: 12px; background-color: white; border-radius: 5px; border-left: 4px solid #3498db; font-size: 0.9em; line-height: 1.4;">
                        <strong style="color: #2c3e50; display: block; margin-bottom: 5px;">Rolling DRMS:</strong> Time-windowed DRMS showing positioning stability over the test duration.
                    </div>
                    <div style="padding: 12px; background-color: white; border-radius: 5px; border-left: 4px solid #3498db; font-size: 0.9em; line-height: 1.4;">
                        <strong style="color: #2c3e50; display: block; margin-bottom: 5px;">Allan Deviation:</strong> Measure of positioning stability and noise characteristics over time.
                    </div>
                    <div style="padding: 12px; background-color: white; border-radius: 5px; border-left: 4px solid #3498db; font-size: 0.9em; line-height: 1.4;">
                        <strong style="color: #2c3e50; display: block; margin-bottom: 5px;">Outlier Rate:</strong> Percentage of fixes classified as outliers (beyond 3σ threshold).
                    </div>
                    <div style="padding: 12px; background-color: white; border-radius: 5px; border-left: 4px solid #3498db; font-size: 0.9em; line-height: 1.4;">
                        <strong style="color: #2c3e50; display: block; margin-bottom: 5px;">Continuous Fix:</strong> Duration of longest continuous fix period without interruption.
                    </div>
                    <div style="padding: 12px; background-color: white; border-radius: 5px; border-left: 4px solid #3498db; font-size: 0.9em; line-height: 1.4;">
                        <strong style="color: #2c3e50; display: block; margin-bottom: 5px;">Fixes:</strong> Total number of position fixes received during the monitoring session.
                    </div>
                    <div style="padding: 12px; background-color: white; border-radius: 5px; border-left: 4px solid #3498db; font-size: 0.9em; line-height: 1.4;">
                        <strong style="color: #2c3e50; display: block; margin-bottom: 5px;">RTCM Messages:</strong> Count of each RTCM correction message type received (format: type:count).
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect ESP IP or use default
        let ESP_IP = '192.168.4.1';
        
        // Try to detect if we're being served from the ESP itself
        if (window.location.hostname && window.location.hostname !== '127.0.0.1' && window.location.hostname !== 'localhost') {
            ESP_IP = window.location.hostname;

        }
        
        let websocket = null;
        let reconnectInterval = null;
        
        // Statistics tracking
        let positionHistory = [];
        let rtcmMessages = {};
        let sessionStartTime = null;
        let lastFixTime = null;
        let continuousFixStart = null;
        let longestContinuousFix = 0;
        let currentContinuousFix = 0;
        
        // Fix type descriptions
        const fixTypes = {
            0: 'No Fix',
            1: '2D Fix',
            2: '3D Fix', 
            3: 'DGPS',
            4: 'RTK Fixed',
            5: 'RTK Float',
            6: 'Estimated',
            7: 'Manual',
            8: 'Simulator'
        };
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logContent = document.getElementById('log-content');
            logContent.textContent += `[${timestamp}] ${message}\n`;
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log-content').textContent = '';
            log('Log cleared');
        }
        
        function resetStatistics() {
            positionHistory = [];
            rtcmMessages = {};
            sessionStartTime = Date.now();
            lastFixTime = null;
            continuousFixStart = null;
            longestContinuousFix = 0;
            currentContinuousFix = 0;
            
            // Clear accuracy displays
            document.getElementById('acc-a95').textContent = '--';
            document.getElementById('acc-drms').textContent = '--';
            document.getElementById('acc-r95').textContent = '--';
            document.getElementById('acc-rolling-drms').textContent = '--';
            document.getElementById('acc-north-mad').textContent = '--';
            document.getElementById('acc-east-mad').textContent = '--';
            document.getElementById('acc-allan').textContent = '--';
            document.getElementById('acc-outliers').textContent = '--';
            document.getElementById('acc-fixes').textContent = '--';
            document.getElementById('acc-continuous').textContent = '--';
            document.getElementById('acc-session-time').textContent = '--';
            document.getElementById('acc-rtcm').textContent = '--';
            
            log('Statistics reset');
        }
        
        function updateConnectionStatus(connected, message) {
            const indicator = document.getElementById('connection-status');
            const text = document.getElementById('connection-text');
            
            if (connected) {
                indicator.className = 'status-indicator status-online';
                text.textContent = message || 'Connected to ' + ESP_IP;
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = message || 'Disconnected from ' + ESP_IP;
            }
        }
        
        function updateGPSData(data) {
            // Proper validation for lat/lon - check for null/undefined, not falsy (0.0 is valid!)
            document.getElementById('gps-lat').textContent = (data.lat != null && data.lat !== undefined) ? data.lat.toFixed(6) : '--';
            document.getElementById('gps-lon').textContent = (data.lon != null && data.lon !== undefined) ? data.lon.toFixed(6) : '--';
            document.getElementById('gps-ele').textContent = (data.ele != null && data.ele !== undefined) ? data.ele.toFixed(1) + 'm' : '--';
            document.getElementById('gps-type').textContent = fixTypes[data.type] || data.type || '--';
            document.getElementById('gps-siv').textContent = (data.siv != null && data.siv !== undefined) ? data.siv : '--';
            document.getElementById('gps-hdop').textContent = (data.hdop != null && data.hdop !== undefined) ? data.hdop.toFixed(2) : '--';
            document.getElementById('gps-rssi').textContent = (data.rssi != null && data.rssi !== undefined) ? data.rssi + 'dBm' : '--';
            
            document.getElementById('data-status').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
            
            // Update statistics if we have a valid position
            if (data.lat != null && data.lon != null && (data.lat !== 0.0 || data.lon !== 0.0) && data.type >= 2) {
                updatePositionStatistics(data);
            } else {
                updateContinuousFix(false);
            }
        }
        
        function updateConfiguration(config) {
            const configDisplay = document.getElementById('config-display');
            if (config) {
                configDisplay.textContent = config;
            } else {
                configDisplay.innerHTML = '<span class="error">Failed to load configuration</span>';
            }
        }
        
        function updatePositionStatistics(data) {
            if (!sessionStartTime) {
                sessionStartTime = Date.now();
            }
            
            const now = Date.now();
            const position = {
                lat: data.lat,
                lon: data.lon,
                ele: (data.ele !== null && data.ele !== undefined) ? data.ele : 0,
                timestamp: now,
                type: data.type
            };
            
            positionHistory.push(position);
            updateContinuousFix(true);
            
            // Keep only last 1000 positions to prevent memory issues
            if (positionHistory.length > 1000) {
                positionHistory = positionHistory.slice(-1000);
            }
            
            // Calculate statistics if we have enough data
            if (positionHistory.length >= 5) {
                calculateAccuracyMetrics();
            }
            
            // Update session statistics
            updateSessionStats();
        }
        
        function updateContinuousFix(hasFix) {
            const now = Date.now();
            
            if (hasFix) {
                if (!continuousFixStart) {
                    continuousFixStart = now;
                }
                currentContinuousFix = Math.floor((now - continuousFixStart) / 1000);
                lastFixTime = now;
            } else {
                if (continuousFixStart) {
                    longestContinuousFix = Math.max(longestContinuousFix, currentContinuousFix);
                    continuousFixStart = null;
                    currentContinuousFix = 0;
                }
            }
        }
        
        function toRadians(degrees) {
            return degrees * Math.PI / 180;
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth radius in meters
            const dLat = toRadians(lat2 - lat1);
            const dLon = toRadians(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function calculateAccuracyMetrics() {
            if (positionHistory.length < 5) return;
            
            // Calculate centroid
            const centroid = {
                lat: positionHistory.reduce((sum, p) => sum + p.lat, 0) / positionHistory.length,
                lon: positionHistory.reduce((sum, p) => sum + p.lon, 0) / positionHistory.length
            };
            
            // Calculate distances from centroid
            const distances = positionHistory.map(p => 
                calculateDistance(centroid.lat, centroid.lon, p.lat, p.lon)
            );
            
            // Sort distances for percentile calculations
            const sortedDistances = [...distances].sort((a, b) => a - b);
            
            // DRMS (63% confidence)
            const drmsIndex = Math.floor(sortedDistances.length * 0.63);
            const drms = sortedDistances[drmsIndex];
            
            // R95 (95% confidence)
            const r95Index = Math.floor(sortedDistances.length * 0.95);
            const r95 = sortedDistances[r95Index];
            
            // Calculate North/East components (simplified approximation)
            const earthRadius = 6371000;
            const latScale = Math.PI * earthRadius / 180;
            const lonScale = latScale * Math.cos(toRadians(centroid.lat));
            
            const northErrors = positionHistory.map(p => (p.lat - centroid.lat) * latScale);
            const eastErrors = positionHistory.map(p => (p.lon - centroid.lon) * lonScale);
            
            // MAD-based standard deviation
            const northMAD = calculateMAD(northErrors);
            const eastMAD = calculateMAD(eastErrors);
            
            // A95 ellipse area (simplified circular approximation)
            const a95 = Math.PI * r95 * r95;
            
            // Rolling DRMS (last 50 points)
            let rollingDRMS = drms;
            if (positionHistory.length >= 50) {
                const recentPositions = positionHistory.slice(-50);
                const recentCentroid = {
                    lat: recentPositions.reduce((sum, p) => sum + p.lat, 0) / recentPositions.length,
                    lon: recentPositions.reduce((sum, p) => sum + p.lon, 0) / recentPositions.length
                };
                const recentDistances = recentPositions.map(p => 
                    calculateDistance(recentCentroid.lat, recentCentroid.lon, p.lat, p.lon)
                ).sort((a, b) => a - b);
                const recentDrmsIndex = Math.floor(recentDistances.length * 0.63);
                rollingDRMS = recentDistances[recentDrmsIndex];
            }
            
            // Outlier detection (3-sigma)
            const mean = distances.reduce((sum, d) => sum + d, 0) / distances.length;
            const variance = distances.reduce((sum, d) => sum + Math.pow(d - mean, 2), 0) / distances.length;
            const stdDev = Math.sqrt(variance);
            const threshold = mean + 3 * stdDev;
            const outliers = distances.filter(d => d > threshold).length;
            const outlierRate = (outliers / distances.length) * 100;
            
            // Allan deviation (simplified - using standard deviation of consecutive differences)
            let allanDev = 0;
            if (positionHistory.length >= 10) {
                const diffs = [];
                for (let i = 1; i < distances.length; i++) {
                    diffs.push(Math.abs(distances[i] - distances[i-1]));
                }
                allanDev = Math.sqrt(diffs.reduce((sum, d) => sum + d*d, 0) / diffs.length / 2);
            }
            
            // Update display
            updateAccuracyDisplay({
                a95: a95,
                drms: drms,
                r95: r95,
                rollingDRMS: rollingDRMS,
                northMAD: northMAD,
                eastMAD: eastMAD,
                allanDev: allanDev,
                outlierRate: outlierRate
            });
        }
        
        function calculateMAD(values) {
            const median = values.slice().sort((a, b) => a - b)[Math.floor(values.length / 2)];
            const deviations = values.map(v => Math.abs(v - median));
            const madMedian = deviations.slice().sort((a, b) => a - b)[Math.floor(deviations.length / 2)];
            return madMedian * 1.4826; // Convert MAD to standard deviation equivalent
        }
        
        function updateAccuracyDisplay(metrics) {
            document.getElementById('acc-a95').textContent = metrics.a95.toFixed(6) + ' m²';
            document.getElementById('acc-drms').textContent = metrics.drms.toFixed(2) + ' m';
            document.getElementById('acc-r95').textContent = metrics.r95.toFixed(2) + ' m';
            document.getElementById('acc-rolling-drms').textContent = metrics.rollingDRMS.toFixed(2) + ' m';
            document.getElementById('acc-north-mad').textContent = metrics.northMAD.toFixed(3) + ' m';
            document.getElementById('acc-east-mad').textContent = metrics.eastMAD.toFixed(3) + ' m';
            document.getElementById('acc-allan').textContent = metrics.allanDev.toFixed(3) + ' m';
            
            // Color code outlier rate
            const outlierEl = document.getElementById('acc-outliers');
            outlierEl.textContent = metrics.outlierRate.toFixed(1) + '%';
            outlierEl.className = metrics.outlierRate > 10 ? 'metric-error' : 
                                 metrics.outlierRate > 5 ? 'metric-warning' : 'metric-good';
        }
        
        function updateSessionStats() {
            document.getElementById('acc-fixes').textContent = positionHistory.length.toString();
            
            const currentContinuous = Math.max(longestContinuousFix, currentContinuousFix);
            const minutes = Math.floor(currentContinuous / 60);
            const seconds = currentContinuous % 60;
            document.getElementById('acc-continuous').textContent = 
                minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
            
            if (sessionStartTime) {
                const sessionDuration = Math.floor((Date.now() - sessionStartTime) / 1000);
                const sessionMinutes = Math.floor(sessionDuration / 60);
                const sessionSeconds = sessionDuration % 60;
                document.getElementById('acc-session-time').textContent = 
                    sessionMinutes > 0 ? `${sessionMinutes}m ${sessionSeconds}s` : `${sessionSeconds}s`;
            }
            
            // Format RTCM messages
            let rtcmText = '';
            Object.entries(rtcmMessages).forEach(([type, count]) => {
                rtcmText += `${type}:${count} `;
            });
            document.getElementById('acc-rtcm').textContent = rtcmText || '--';
        }
        
        function requestCurrentConfig() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                log('Cannot request config - WebSocket not connected');
                return;
            }
            
            const configRequest = {
                type: 'get_config',
                timestamp: Date.now()
            };
            
            try {
                websocket.send(JSON.stringify(configRequest));
                log('Requested current configuration');
                document.getElementById('config-display').innerHTML = '<span class="loading">Loading configuration...</span>';
            } catch (error) {
                log('Failed to request configuration: ' + error.message);
            }
        }
        
        // WebSocket connection
        function initWebSocket() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.close();
            }
            
            if (reconnectInterval) {
                clearInterval(reconnectInterval);
                reconnectInterval = null;
            }
            
            const wsUrl = `ws://${ESP_IP}/json`;
            log('Connecting to ' + wsUrl);
            
            try {
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function(event) {
                    log('WebSocket connected');
                    updateConnectionStatus(true);
                    
                    // Request initial configuration
                    setTimeout(requestCurrentConfig, 500);
                };
                
                websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        
                        // Handle GPS data
                        if (data.lat !== undefined || data.lon !== undefined) {
                            updateGPSData(data);
                        }
                        
                        // Handle configuration response  
                        if (data.type === 'config_status') {
                            if (data.raw_config) {
                                updateConfiguration(data.raw_config);
                                log('Configuration updated');
                            } else if (data.config) {
                                // Convert config object to readable format
                                let configText = '';
                                Object.entries(data.config).forEach(([key, value]) => {
                                    configText += `${key}: ${value}\n`;
                                });
                                updateConfiguration(configText);
                                log('Configuration updated');
                            }
                        }
                        
                        // Handle RTCM message tracking
                        if (data.type === 'rtcm_status' && data.message_type) {
                            const msgType = `RTCM${data.message_type}`;
                            rtcmMessages[msgType] = (rtcmMessages[msgType] || 0) + 1;
                            updateSessionStats();
                        }
                        
                        // Handle command responses (ignore for this simplified version)
                        if (data.type === 'command_response') {
                            log('Command response: ' + (data.response || data.error || 'OK'));
                        }
                        
                    } catch (error) {
                        log('Error parsing WebSocket data: ' + error.message);
                    }
                };
                
                websocket.onclose = function(event) {
                    log('WebSocket disconnected (code: ' + event.code + ')');
                    updateConnectionStatus(false);
                    
                    // Auto-reconnect after 5 seconds
                    reconnectInterval = setTimeout(initWebSocket, 5000);
                };
                
                websocket.onerror = function(error) {
                    log('WebSocket error: ' + error);
                    updateConnectionStatus(false, 'Connection error');
                };
                
            } catch (error) {
                log('Failed to create WebSocket: ' + error.message);
                updateConnectionStatus(false, 'Connection failed');
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            log('GPS Settings Monitor started');
            log('Target ESP32: ' + ESP_IP);
            
            // Initialize statistics
            resetStatistics();
            
            // Start WebSocket connection
            initWebSocket();
        });
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
            if (reconnectInterval) {
                clearInterval(reconnectInterval);
            }
        });
    </script>
</body>
</html>